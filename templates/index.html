<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Media Cleaner</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

            body {
                font-family: "Inter", sans-serif;
                background-color: #f8f9fa;
                color: #1e293b;
            }

            .navbar {
                background: #ffffff !important;
                height: 70px;
            }

            .card {
                border: none;
                border-radius: 12px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                transition: all 0.2s;
            }

            .card:hover {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            }

            .stat-card-icon {
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 12px;
            }

            .table thead th {
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: #64748b;
                border-bottom: 1px solid #e2e8f0;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }

            .table tbody td {
                vertical-align: middle;
                padding-top: 1rem;
                padding-bottom: 1rem;
                font-size: 0.9rem;
                color: #334155;
            }

            .media-badge {
                font-size: 0.7rem;
                font-weight: 600;
                padding: 0.35em 0.65em;
                border-radius: 6px;
            }

            .origin-badge {
                background-color: #f1f5f9;
                color: #475569;
            }

            .status-dot {
                height: 8px;
                width: 8px;
                border-radius: 50%;
                display: inline-block;
                margin-right: 6px;
            }

            .btn-action {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
                border-radius: 6px;
            }

            th.sortable {
                cursor: pointer;
            }
            th.sortable:hover {
                background-color: #e2e8f0;
            }
            .sub-row {
                background-color: #f8f9fa;
                font-size: 0.85rem;
            }
        </style>
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-light fixed-top border-bottom">
            <div class="container-fluid px-4">
                <a class="navbar-brand fw-bold d-flex align-items-center" href="/">
                    <div class="bg-primary text-white rounded p-1 me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px">
                        <i class="bi bi-stars"></i>
                    </div>
                    Media Cleaner
                </a>
                <div class="d-flex align-items-center gap-3">
                    <a href="/settings" class="btn btn-sm btn-outline-secondary rounded-pill px-3"> <i class="bi bi-gear-fill me-1"></i> Settings </a>
                    <div class="d-flex align-items-center gap-2 me-4" id="navbar-service-badges">
                        <!-- Badges injected here -->
                    </div>
                    <div class="d-flex flex-column align-items-end lh-1">
                        <small class="text-muted fw-bold" style="font-size: 0.65rem; letter-spacing: 0.5px">SYSTEM STATUS</small>
                        <div class="d-flex align-items-center mt-1">
                            <span class="status-dot bg-success" id="system-status-dot"></span>
                            <span class="fw-bold" style="font-size: 0.85rem" id="system-status-text">Checking...</span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4" style="margin-top: 90px; max-width: 1600px">
            <!-- Stats Row -->
            <div class="row g-4 mb-4">
                <!-- Storage Usage -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.75rem">Storage Usage</h6>
                                    <h2 class="fw-bold mb-0" id="disk-percent">--%</h2>
                                </div>
                                <div class="stat-card-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="bi bi-hdd-stack-fill fs-5"></i>
                                </div>
                            </div>
                            <div class="progress" style="height: 8px; border-radius: 4px">
                                <div id="disk-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="mt-3 d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="disk-details">Loading...</small>
                                <a href="/settings" class="text-decoration-none">
                                    <span class="badge bg-light text-secondary border" id="disk-limit-badge">Limit: --%</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eligible for Cleanup -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.75rem">Eligible for Cleanup</h6>
                                    <h2 class="fw-bold mb-0" id="eligible-count">--</h2>
                                </div>
                                <div class="stat-card-icon bg-success bg-opacity-10 text-success">
                                    <i class="bi bi-check-circle-fill fs-5"></i>
                                </div>
                            </div>
                            <div class="p-2 bg-light rounded text-center">
                                <small class="fw-semibold text-secondary" id="eligible-status">Scanning...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Scanned -->
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="text-muted text-uppercase fw-bold mb-1" style="font-size: 0.75rem">Total Scanned</h6>
                                    <h2 class="fw-bold mb-0" id="total-count">--</h2>
                                </div>
                                <div class="stat-card-icon bg-info bg-opacity-10 text-info">
                                    <i class="bi bi-search fs-5"></i>
                                </div>
                            </div>
                            <div class="d-flex gap-2 mt-3" id="service-badges">
                                <!-- JS injected -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Media Library Table -->
            <div class="card">
                <div class="card-header bg-white py-3 px-4 border-bottom d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-list-ul text-primary"></i>
                        <h6 class="fw-bold mb-0">Media Library</h6>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">READY</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 sortable" style="width: 100px" onclick="sortTable('origin')">Type ↕</th>
                                <th class="sortable" onclick="sortTable('title')">Media Name ↕</th>
                                <th class="sortable" onclick="sortTable('watched')">Played ↕</th>
                                <th class="sortable" onclick="sortTable('status')">Status ↕</th>
                                <th class="sortable" onclick="sortTable('ratio')">Seed Status ↕</th>
                                <th class="sortable" onclick="sortTable('deletable')">Deletable ↕</th>
                                <th class="text-end pe-4">Action</th>
                            </tr>
                        </thead>
                        <tbody id="media-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            function formatBytes(bytes, decimals = 2) {
                if (!+bytes) return "0 Bytes";
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ["Bytes", "KiB", "MiB", "GiB", "TiB", "PiB", "EiB", "ZiB", "YiB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
            }

            let mediaData = [];
            let sortConfig = { key: "title", asc: true };

            function sortTable(key) {
                if (sortConfig.key === key) {
                    sortConfig.asc = !sortConfig.asc;
                } else {
                    sortConfig.key = key;
                    sortConfig.asc = true;
                }
                renderTable();
            }

            function toggleRow(id) {
                const subRows = document.querySelectorAll(`.sub-row-${id}`);
                const icon = document.getElementById(`icon-${id}`);
                subRows.forEach((row) => {
                    if (row.style.display === "none") {
                        row.style.display = "table-row";
                        icon.classList.remove("bi-chevron-right");
                        icon.classList.add("bi-chevron-down");
                    } else {
                        row.style.display = "none";
                        icon.classList.remove("bi-chevron-down");
                        icon.classList.add("bi-chevron-right");
                    }
                });
            }

            function renderTable() {
                const tbody = document.getElementById("media-table-body");
                tbody.innerHTML = "";

                if (mediaData.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center py-5 text-muted">No media found.</td></tr>`;
                    return;
                }

                // Sort logic
                mediaData.sort((a, b) => {
                    let valA = a[sortConfig.key];
                    let valB = b[sortConfig.key];

                    // Special sort handling
                    if (sortConfig.key === "ratio") {
                        // Extract "Avg: 1.23" or "1.23" -> float
                        valA = parseFloat(String(valA).replace(/[^0-9.]/g, "")) || 0;
                        valB = parseFloat(String(valB).replace(/[^0-9.]/g, "")) || 0;
                    }

                    if (valA < valB) return sortConfig.asc ? -1 : 1;
                    if (valA > valB) return sortConfig.asc ? 1 : -1;
                    return 0;
                });

                mediaData.forEach((item, index) => {
                    const rowId = `row-${index}`;
                    const row = document.createElement("tr");

                    // Expandable Logic
                    const hasTorrents = item.torrents && item.torrents.length > 0 && item.origin === "Sonarr";
                    let titleHtml = `
                        <div class="d-flex flex-column">
                            <span class="fw-bold text-dark">${item.title}</span>
                            <small class="text-muted">${item.year}</small>
                        </div>`;

                    let expandIcon = "";
                    if (hasTorrents) {
                        expandIcon = `<i id="icon-${rowId}" class="bi bi-chevron-right text-muted me-2" style="cursor: pointer; font-size: 0.8rem;" onclick="toggleRow('${rowId}')"></i>`;
                        titleHtml = `<div class="d-flex align-items-center">${expandIcon}${titleHtml}</div>`;
                    }

                    // Type Badge
                    const originBadge = `<span class="badge origin-badge text-uppercase">${item.origin}</span>`;

                    // Played
                    const playedHtml = item.watched ? `<div class="d-flex align-items-center"><span class="status-dot bg-success"></span><span class="fw-semibold text-dark">Watched</span></div>` : `<div class="d-flex align-items-center"><span class="status-dot bg-secondary bg-opacity-25"></span><span class="text-muted">Unwatched</span></div>`;

                    // Seed Status
                    let seedHtml = `<small class="text-muted">N/A</small>`;
                    if (item.torrent_state !== "N/A") {
                        seedHtml = `
                            <div class="d-flex flex-column" style="font-size: 0.8rem;">
                                <div><span class="fw-bold">${item.ratio}</span> <span class="text-muted" style="font-size:0.7rem">RATIO</span></div>
                                <div><span class="fw-bold">${item.seed_time}</span> <span class="text-muted" style="font-size:0.7rem">TIME</span></div>
                            </div>
                        `;
                    }

                    // Media Status
                    let statusColor = "text-muted";
                    if (item.status === "Downloaded") statusColor = "text-success";
                    else if (item.status === "Missing") statusColor = "text-danger";
                    else if (String(item.status).includes("Partial")) statusColor = "text-warning";

                    // Deletable Check
                    let deletableHtml = item.deletable ? `<span class="badge bg-success bg-opacity-10 text-success">YES</span>` : `<span class="badge bg-secondary bg-opacity-10 text-secondary">NO</span>`;

                    // Action
                    let actionHtml = "";
                    const safeTitle = item.title.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                    const hashes = (item.torrent_hashes || []).join(",");

                    if (item.deletable) {
                        actionHtml = `
                            <button onclick="openDeleteModal('${safeTitle}', '${item.origin}', '${item.id}', '${hashes}', 'media')"
                                    class="btn btn-sm btn-danger btn-action shadow-sm">
                                <i class="bi bi-trash-fill me-1"></i> Delete
                            </button>`;
                    } else {
                        actionHtml = `<span class="text-muted small fw-bold" style="opacity: 0.5">PROTECTED</span>`;
                    }

                    row.innerHTML = `
                        <td class="ps-4">${originBadge}</td>
                        <td>${titleHtml}</td>
                        <td>${playedHtml}</td>
                        <td><small class="${statusColor} fw-bold text-uppercase" style="font-size: 0.75rem;">${item.status}</small></td>
                        <td>${seedHtml}</td>
                        <td>${deletableHtml}</td>
                        <td class="text-end pe-4">${actionHtml}</td>
                    `;
                    tbody.appendChild(row);

                    // Render Sub-Rows for Torrents
                    if (hasTorrents) {
                        item.torrents.forEach((t) => {
                            const subRow = document.createElement("tr");
                            subRow.className = `sub-row sub-row-${rowId}`;
                            subRow.style.display = "none";

                            const tSafeName = (t.name || t.label).replace(/'/g, "\\'").replace(/"/g, "&quot;");
                            const tHash = t.hash;

                            subRow.innerHTML = `
                                <td></td>
                                <td colspan="3" class="ps-5 text-muted fst-italic"><i class="bi bi-arrow-return-right me-2"></i>${t.label}</td>
                                <td>
                                    <div class="d-flex gap-3" style="font-size: 0.75rem;">
                                        <span>R: <strong>${t.ratio}</strong></span>
                                        <span>T: <strong>${t.seed_time}</strong></span>
                                    </div>
                                </td>
                                <td></td>
                                <td class="text-end pe-4">
                                     <button onclick="openDeleteModal('${tSafeName}', '${item.origin}', '${item.id}', '${tHash}', 'torrent')"
                                    class="btn btn-sm btn-outline-danger btn-action" style="font-size: 0.7rem; padding: 0.2rem 0.5rem">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </td>
                            `;
                            tbody.appendChild(subRow);
                        });
                    }
                });
            }

            async function loadDashboard() {
                try {
                    const response = await fetch("/api/scan");
                    const data = await response.json();
                    mediaData = data.media;

                    // 1. Update Config & Disk
                    const disk = data.disk_usage;
                    if (disk) {
                        document.getElementById("disk-percent").textContent = `${disk.percent}%`;
                        document.getElementById("disk-bar").style.width = `${disk.percent}%`;
                        document.getElementById("disk-bar").className = `progress-bar ${disk.percent > 90 ? "bg-danger" : disk.percent > 75 ? "bg-warning" : "bg-primary"}`;
                        document.getElementById("disk-details").textContent = `${disk.free} free of ${disk.total}`;
                    }
                    document.getElementById("disk-limit-badge").textContent = `Limit: ${data.config.disk_threshold}%`;

                    // 2. Stats
                    document.getElementById("eligible-count").textContent = `${data.stats.eligible} Items`;
                    document.getElementById("eligible-status").textContent = data.stats.eligible > 0 ? "Cleanup Recommended" : "System Healthy";
                    document.getElementById("total-count").textContent = `${data.stats.total} Items`;

                    // 3. Services Badges
                    const navbarBadges = document.getElementById("navbar-service-badges");
                    navbarBadges.innerHTML = "";
                    let allOnline = true;
                    for (const [name, online] of Object.entries(data.services)) {
                        if (!online) allOnline = false;
                        const badge = document.createElement("span");
                        badge.className = `badge ${online ? "bg-success" : "bg-danger"}`;
                        badge.textContent = name;
                        navbarBadges.appendChild(badge);
                    }

                    // System Status
                    const sysDot = document.getElementById("system-status-dot");
                    const sysText = document.getElementById("system-status-text");
                    if (allOnline) {
                        sysDot.className = "status-dot bg-success";
                        sysText.textContent = "Service Online";
                    } else {
                        sysDot.className = "status-dot bg-danger";
                        sysText.textContent = "Service Issues";
                    }

                    // 4. Render Table
                    renderTable();
                } catch (e) {
                    console.error(e);
                    document.getElementById("media-table-body").innerHTML = `<tr><td colspan="7" class="text-center py-5 text-danger">Error loading data.</td></tr>`;
                }
            }

            let deleteModal;

            function openDeleteModal(title, origin, id, hashes, deleteType) {
                document.getElementById("delete-modal-title").textContent = title;
                document.getElementById("delete-origin").value = origin;
                document.getElementById("delete-id").value = id;
                document.getElementById("delete-hashes").value = hashes;
                document.getElementById("delete-type").value = deleteType;

                const msg = deleteType === "torrent" ? "Delete this specific torrent? The media item will remain in library." : "This action is permanent. Files will be deleted from disk and torrents removed from client.";
                document.getElementById("delete-warning-text").textContent = msg;

                if (!deleteModal) {
                    deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
                }
                deleteModal.show();
            }

            document.addEventListener("DOMContentLoaded", loadDashboard);
        </script>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-bottom-0 pb-0">
                        <h5 class="modal-title fw-bold">Confirm Deletion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-2">
                        <p class="mb-3 fs-5">Delete <strong id="delete-modal-title" class="text-dark"></strong>?</p>
                        <div class="alert alert-danger border-0 bg-danger bg-opacity-10 text-danger d-flex align-items-center mb-0" role="alert">
                            <i class="bi bi-exclamation-octagon-fill fs-4 me-3"></i>
                            <div class="small fw-semibold" id="delete-warning-text">This action is permanent. Files will be deleted from disk and torrents removed from client.</div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0 bg-light rounded-bottom">
                        <button type="button" class="btn btn-outline-secondary px-4 fw-semibold" data-bs-dismiss="modal">Cancel</button>
                        <form action="/delete" method="POST" class="m-0">
                            <input type="hidden" name="origin" id="delete-origin" />
                            <input type="hidden" name="id" id="delete-id" />
                            <input type="hidden" name="torrent_hashes" id="delete-hashes" />
                            <input type="hidden" name="delete_type" id="delete-type" />
                            <button type="submit" class="btn btn-danger px-4 fw-bold">Yes, Delete It</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>
